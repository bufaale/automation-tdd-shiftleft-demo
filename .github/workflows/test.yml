name: TDD + Shift Left Pipeline

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout repo
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🟥 Run RED test (expected to fail)
        run: mvn test -Dtest=UserTest || true

      - name: 🚀 Start backend with Docker Compose
        run: docker compose up -d --build

      - name: ⏱ Wait for backend to be ready
        run: |
          echo "Waiting for backend..."
          for i in {1..10}; do
            nc -z localhost 8080 && echo "✅ Backend is up!" && break
            echo "⏳ Still waiting..."
            sleep 3
          done

      - name: 🟩 Run GREEN test
        run: mvn test -Dtest=UserGreenTest

      - name: ✅ VERIFY backend behavior
        run: mvn test -Dtest=UserGreenTest

      - name: 📦 Build backend if tests pass
        run: mvn clean package
